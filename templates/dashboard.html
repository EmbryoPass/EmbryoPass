<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Dashboard - Museo de Embriolog√≠a</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>
<body class="bg-light">
<div class="container p-3">
    <h1 class="text-center mb-4">üèõÔ∏è Panel de Administraci√≥n</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} text-center">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <h2 class="mt-4">Citas Agendadas</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th>Nombre</th>
                    <th>Edad</th>
                    <th>Sexo</th>
                    <th>Correo</th>
                    <th>Tel√©fono</th>
                    <th>Fecha y Hora</th>
                    <th>Acciones</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in citas %}
                <tr>
                    <td>{{ cita[1] }}</td>
                    <td>{{ cita[7] or '‚Äî' }}</td>
                    <td>{{ cita[8] or '‚Äî' }}</td>
                    <td>{{ cita[2] }}</td>
                    <td>{{ cita[3] }}</td>
                    <td>{{ cita[4] }}</td>
                    <td>
                        {% if cita[5] == 'activa' %}
                        <a href="{{ url_for('cancelar_cita', id_cita=cita[0]) }}" class="btn btn-danger btn-sm">Cancelar</a>
                        {% else %}
                        <span class="badge bg-secondary">Cancelada</span>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('eliminar_cita', id_cita=cita[0]) }}" class="btn btn-outline-danger btn-sm">üóëÔ∏è</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 class="mt-5">Horarios Disponibles</h2>
    <div class="table-responsive">
        <table class="table table-striped table-hover shadow-sm">
            <thead class="table-dark">
                <tr>
                    <th>Fecha y Hora</th>
                    <th>Disponibles</th>
                    <th>Capacidad</th>
                    <th>Acciones</th>
                </tr>
            </thead>
            <tbody>
                {% for horario in horarios %}
                <tr>
                    <td>{{ horario[1] }}</td>
                    <td>{{ horario[2] }}</td>
                    <td>{{ horario[3] }}</td>
                    <td>
                        <a href="{{ url_for('eliminar_horario', id_horario=horario[0]) }}" class="btn btn-danger btn-sm text-white">Cancelar</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <h2 class="mt-5">Solicitudes de Visitas Grupales Institucionales</h2>
    <div class="table-responsive">
      <table class="table table-bordered table-hover shadow-sm">
        <thead class="table-secondary">
          <tr>
            <th>Instituci√≥n</th>
            <th>Encargado</th>
            <th>Correo</th>
            <th>Tel√©fono</th>
            <th>Nivel</th>
            <th>Alumnos</th>
            <th>Estado</th>
            <th>Fecha sugerida</th>
            <th>Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for visita in visitas_grupales %}
          <tr>
            <td>{{ visita.institucion }}</td>
            <td>{{ visita.encargado }}</td>
            <td>{{ visita.correo }}</td>
            <td>{{ visita.telefono }}</td>
            <td>{{ visita.nivel }}</td>
            <td>{{ visita.numero_alumnos }}</td>
            <td>
              {% if visita.estado == 'pendiente' %}
                <span class="badge bg-warning text-dark">Pendiente</span>
              {% elif visita.estado == 'aceptada' %}
                <span class="badge bg-success">Aceptada</span>
              {% elif visita.estado == 'rechazada' %}
                <span class="badge bg-danger">Rechazada</span>
              {% endif %}
            </td>
            <td>
              {% if visita.fecha_confirmada %}
                {{ visita.fecha_confirmada }}
              {% else %}
                <span class="text-muted">No confirmada</span>
              {% endif %}
            </td>
            <td>
              {% if visita.estado == 'pendiente' %}
              <div class="d-flex gap-1">
                <a href="{{ url_for('aceptar_visita', id=visita.id) }}" class="btn btn-sm btn-success">Aceptar</a>
                <a href="{{ url_for('rechazar_visita', id=visita.id) }}" class="btn btn-sm btn-danger">Rechazar</a>
              </div>
              {% elif visita.estado == 'aceptada' %}
              <form method="POST" action="{{ url_for('asignar_fecha_visita', id=visita.id) }}" class="d-flex gap-2 align-items-center">
                <input type="text" name="fecha_confirmada" class="form-control form-control-sm" placeholder="dd/mm/aaaa hh:mm">
                <button type="submit" class="btn btn-sm btn-outline-primary">Asignar fecha</button>
              </form>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h2 class="mt-5">Agregar Nuevo Horario</h2>
    <form method="POST" action="{{ url_for('agregar_horario') }}" class="card p-4 shadow-sm">
        <div class="mb-3">
            <label for="fecha_hora" class="form-label">Fecha y Hora</label>
            <input type="text" class="form-control" id="fecha_hora" name="fecha_hora" placeholder="Selecciona fecha y hora" required>
        </div>
        <div class="mb-3">
            <label for="disponibles" class="form-label">N√∫mero de espacios disponibles</label>
            <input type="number" class="form-control" id="disponibles" name="disponibles" min="1" max="20" required>
        </div>
        <div class="text-center">
            <button type="submit" class="btn btn-success w-100">Agregar Horario</button>
        </div>
    </form>

    <h2 class="mt-5">Historial de Citas Pasadas</h2>

    <form method="get" class="row g-2 align-items-center mb-3">
      <div class="col-auto">
        <label for="rango" class="form-label fw-bold mb-0">Filtrar historial:</label>
      </div>
      <div class="col-auto">
        <select name="rango" id="rango" class="form-select form-select-sm">
          <option value="7" {% if rango == '7' %}selected{% endif %}>√öltimos 7 d√≠as</option>
          <option value="30" {% if rango == '30' %}selected{% endif %}>√öltimos 30 d√≠as</option>
          <option value="mes" {% if rango == 'mes' %}selected{% endif %}>Este mes</option>
          <option value="todo" {% if rango == 'todo' %}selected{% endif %}>Todo el historial</option>
        </select>
      </div>
      <div class="col-auto">
        <button type="submit" class="btn btn-outline-primary btn-sm">Aplicar</button>
      </div>
      <div class="col-auto">
        <a href="{{ url_for('descargar_historial', rango=rango) }}" class="btn btn-outline-success btn-sm">üì• Descargar historial en Excel</a>
      </div>
    </form>

    <div class="table-responsive">
        <table class="table table-bordered table-hover shadow-sm">
            <thead class="table-secondary">
                <tr>
                    <th>Nombre</th>
                    <th>Edad</th>
                    <th>Sexo</th>
                    <th>Correo</th>
                    <th>Tel√©fono</th>
                    <th>Fecha y Hora</th>
                    <th>Estado</th>
                    <th>Asistencia</th>
                    <th>Eliminar</th>
                </tr>
            </thead>
            <tbody>
                {% for cita in historial %}
                <tr>
                    <td>{{ cita[1] }}</td>
                    <td>{{ cita[7] or '‚Äî' }}</td>
                    <td>{{ cita[8] or '‚Äî' }}</td>
                    <td>{{ cita[2] }}</td>
                    <td>{{ cita[3] }}</td>
                    <td>{{ cita[4] }}</td>
                    <td>
                        {% if cita[5] == 'activa' %}
                            <span class="badge bg-primary">Finalizada</span>
                        {% else %}
                            <span class="badge bg-secondary">Cancelada</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if cita[5] == 'cancelada' %}
                            <span class="text-muted">‚Äî</span>
                        {% else %}
                            <div class="d-flex flex-column gap-1">
                                {% if cita[6] == 's√≠' %}
                                    <span class="badge bg-success">‚úîÔ∏è Asisti√≥</span>
                                {% elif cita[6] == 'no' %}
                                    <span class="badge bg-danger">‚ùå No asisti√≥</span>
                                {% else %}
                                    <span class="badge bg-warning text-dark">Sin registrar</span>
                                {% endif %}

                                <div class="dropdown">
                                    <button class="btn btn-sm btn-outline-primary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        Modificar
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="{{ url_for('marcar_asistencia', id_cita=cita[0], estado='s√≠') }}">‚úîÔ∏è Asisti√≥</a></li>
                                        <li><a class="dropdown-item" href="{{ url_for('marcar_asistencia', id_cita=cita[0], estado='no') }}">‚ùå No asisti√≥</a></li>
                                    </ul>
                                </div>
                            </div>
                        {% endif %}
                    </td>
                    <td>
                        <a href="{{ url_for('eliminar_cita', id_cita=cita[0]) }}" class="btn btn-outline-danger btn-sm">üóëÔ∏è</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div class="text-center mt-4">
        <a href="{{ url_for('logout') }}" class="btn btn-danger">Cerrar sesi√≥n</a>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    flatpickr("#fecha_hora", {
        enableTime: true,
        dateFormat: "d/m/Y h:i K",
        time_24hr: false
    });

    document.addEventListener("DOMContentLoaded", function () {
        const enlaces = document.querySelectorAll('a.btn-danger, a.btn-outline-danger');

        enlaces.forEach(function (enlace) {
            enlace.addEventListener('click', function (e) {
                const texto = enlace.textContent.toLowerCase();
                let mensaje = "¬øEst√°s seguro de que deseas continuar?";
                if (texto.includes("cancelar")) mensaje = "¬øDeseas cancelar esta cita u horario?";
                if (texto.includes("üóë")) mensaje = "¬øDeseas eliminar esta cita permanentemente?";
                if (!confirm(mensaje)) {
                    e.preventDefault();
                }
            });
        });
    });
</script>
</body>
</html>
