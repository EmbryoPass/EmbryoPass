<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Museo de Embriolog√≠a</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background-color: #fdf9f3;
      font-family: 'Roboto', sans-serif;
      color: #333;
      min-height: 100vh;
    }

    .container {
      background-color: transparent !important;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }

    h1, h2, h3 {
      font-weight: 700;
      color: #222;
    }

    .btn-pastel-primary {
      background-color: #a7dffb;
      border-color: #a7dffb;
      color: #004e6b;
    }
    .btn-pastel-primary:hover {
      background-color: #8fd3f5;
      border-color: #8fd3f5;
    }

    .btn-pastel-success {
      background-color: #b9e4c9;
      border-color: #b9e4c9;
      color: #2e6e4c;
    }
    .btn-pastel-success:hover {
      background-color: #a0d8b6;
      border-color: #a0d8b6;
    }

    .btn-pastel-danger {
      background-color: #f7c6c7;
      border-color: #f7c6c7;
      color: #842029;
    }
    .btn-pastel-danger:hover {
      background-color: #f3b0b2;
      border-color: #f3b0b2;
    }

    .btn-pastel-secondary {
      background-color: #eaeaea;
      border-color: #eaeaea;
      color: #555;
    }
    .btn-pastel-secondary:hover {
      background-color: #dcdcdc;
      border-color: #dcdcdc;
    }

    .btn-disabled {
      background-color: #f0f0f0;
      border-color: #f0f0f0;
      color: #999;
      cursor: not-allowed;
      pointer-events: none;
      opacity: 0.7;
    }

    /* Logo estilo inicio */
    .main-logo {
      display: block;
      margin: 1.5rem auto;
      height: 80px;
    }

/* T√≠tulo museo estilo inicio */
    .title-text {
      text-align: center;
      margin: 2rem 0;
    }
    .title-text h1 {
      font-family: 'Nunito', sans-serif;
      font-size: 2.25rem;
      font-weight: 700;
      letter-spacing: 0.05em;
      color: #4a3526;
      padding-bottom: 0.5rem;
      border-bottom: 2px solid rgba(0,0,0,0.1);
      display: inline-block;
    }
    .title-text small {
      display: block;
      margin-top: 0.5rem;
      font-variant: small-caps;
      letter-spacing: 0.02em;
      color: #555;
    }

    .section-title {
      font-size: 1.75rem; /* tama√±o para escritorio */
      font-weight: 700;
      margin-bottom: 1rem;
    }

    /* Ajuste para pantallas peque√±as (m√≥viles) */
    @media (max-width: 576px) {
      .section-title {
        font-size: 1.25rem; /* tama√±o reducido en m√≥viles */
        margin-bottom: 0.75rem;
      }
    }

    .table thead {
      background-color: #e9ecef;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Logo y t√≠tulo museo estilo inicio -->
    <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo Museo" class="main-logo">

    <div class="title-text">
      <h1>Museo de Embriolog√≠a</h1>
      <small>Dra. Dora Virginia Ch√°vez Corral</small>
    </div>
    
    <h1 class="text-center mb-4">Panel de Administraci√≥n</h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="alert alert-{{ category }} text-center">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <h2 class="section-title mt-4">Citas Agendadas</h2>

    <div class="table-responsive">
      <table class="table table-striped table-hover shadow-sm">
        <thead class="table-light">
          <tr>
            <th>Nombre</th>
            <th>Edad</th>
            <th>Sexo</th>
            <th>Instituci√≥n</th>
            <th>Nivel Acad√©mico</th>
            <th>Correo</th>
            <th>Tel√©fono</th>
            <th>Fecha y Hora</th>
            <th>Cancelar</th>
          </tr>
        </thead>
        <tbody>
          {% for cita in citas %}
          <tr>
            <td>{{ cita[1] }}</td>
            <td>{{ cita[7] or '‚Äî' }}</td>
            <td>{{ cita[8] or '‚Äî' }}</td>
            <td>{{ cita[9] or '‚Äî' }}</td>
            <td>{{ cita[10] or '‚Äî' }}</td>
            <td>{{ cita[2] }}</td>
            <td>{{ cita[3] }}</td>
            <td>{{ cita[4] }}</td>
            <td>
              {% if cita[5] == 'activa' %}
                <a href="{{ url_for('cancelar_cita', id_cita=cita[0]) }}" class="btn btn-pastel-danger btn-sm">
                  Cancelar
                </a>
              {% else %}
                <span class="badge bg-secondary">Cancelada</span>
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h2 class="section-title mt-5">Horarios Disponibles</h2>

    <div class="table-responsive">
      <table class="table table-striped table-hover shadow-sm">
        <thead class="table-light">
          <tr>
            <th>Fecha y Hora</th>
            <th>Disponibles</th>
            <th>Capacidad</th>
            <th>Cancelar</th>
          </tr>
        </thead>
        <tbody>
          {% for horario in horarios %}
          <tr>
            <td>{{ horario[1] }}</td>
            <td>{{ horario[2] }}</td>
            <td>{{ horario[3] }}</td>
            <td>
              <a href="{{ url_for('eliminar_horario', id_horario=horario[0]) }}" class="btn btn-pastel-danger btn-sm">
                Cancelar
              </a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

<h2 class="section-title mt-5">Solicitudes de Visitas Grupales</h2>

<div class="table-responsive">
  <table class="table table-bordered table-hover shadow-sm">
    <thead class="table-light">
      <tr>
        <th>Instituci√≥n</th>
        <th>Encargado</th>
        <th>Correo</th>
        <th>Tel√©fono</th>
        <th>Nivel Acad√©mico</th>
        <th>Alumnos</th>
        <th>Fechas Propuestas</th>
        <th>Comentarios</th>
        <th>Estado</th>
        <th>Fecha confirmada</th>
        <th>Acciones</th>
        <th>Cancelar</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody>
      {% for visita in visitas_grupales %}
      <tr>
        <td>{{ visita.institucion }}</td>
        <td>{{ visita.encargado }}</td>
        <td>{{ visita.correo }}</td>
        <td>{{ visita.telefono }}</td>
        <td>{{ visita.nivel }}</td>
        <td>{{ visita.numero_alumnos }}</td>
        <td>{{ visita.fechas_preferidas }}</td>
        <td>{{ visita.comentarios or '‚Äî' }}</td>
        <td>
          {% if visita.estado == 'pendiente' %}
            <span class="badge bg-warning text-dark">Pendiente</span>
          {% elif visita.estado == 'aceptada' %}
            <span class="badge bg-success">Aceptada</span>
          {% elif visita.estado == 'rechazada' %}
            <span class="badge bg-danger">Rechazada</span>
          {% endif %}
        </td>
        <td>{{ visita.fecha_confirmada or '‚Äî' }}</td>
        <td>
          {% if visita.estado == 'pendiente' %}
            <a href="{{ url_for('aceptar_visita', id=visita.id) }}" class="btn btn-sm btn-pastel-success mb-1">Aceptar</a>
            <a href="{{ url_for('rechazar_visita', id=visita.id) }}" class="btn btn-sm btn-pastel-danger mb-1">Rechazar</a>
          {% elif visita.estado == 'aceptada' %}
            <form action="{{ url_for('asignar_fecha_visita', id=visita.id) }}" method="POST" class="d-flex flex-column">
              <input type="text" name="fecha_confirmada" placeholder="dd/mm/aaaa" class="form-control form-control-sm mb-1 fecha-confirmada" required>
              <button type="submit" class="btn btn-sm btn-pastel-primary btn-asignar-fecha" disabled>Asignar Fecha</button>
            </form>
          {% endif %}
        </td>
        <td>
          {% if visita.estado != 'cancelada' %}
            <a href="{{ url_for('cancelar_visita_grupal', id=visita.id) }}" class="btn btn-sm btn-pastel-danger cancelar-visita-btn">Cancelar</a>
          {% else %}
            <span class="badge bg-secondary">Cancelada</span>
          {% endif %}
        </td>
        <td>
          {% if visita.estado == 'cancelada' %}
            <a href="{{ url_for('eliminar_visita_grupal', id=visita.id) }}" class="btn btn-sm btn-outline-danger eliminar-visita-btn" title="Eliminar visita cancelada">üóëÔ∏è</a>
          {% else %}
            <button class="btn btn-sm btn-disabled" title="Solo se puede eliminar si la visita est√° cancelada">üóëÔ∏è</button>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

    
<script>
  document.addEventListener("DOMContentLoaded", function() {
    // Para cada formulario con campo fecha-confirmada
    document.querySelectorAll('form.d-flex.flex-column').forEach(function(form) {
      const inputFecha = form.querySelector('.fecha-confirmada');
      const btnAsignar = form.querySelector('.btn-asignar-fecha');
      
      inputFecha.addEventListener('input', function() {
        btnAsignar.disabled = inputFecha.value.trim() === '';
      });
    });
  });
</script>

    <h2 class="section-title mt-5">Estudiantes Registrados en Visitas Grupales</h2>

<div class="table-responsive">
  <table class="table table-bordered table-hover shadow-sm">
    <thead class="table-light">
      <tr>
        <th>Nombre</th>
        <th>Correo</th>
        <th>Edad</th>
        <th>Sexo</th>
        <th>Instituci√≥n</th>
        <th>Nivel acad√©mico</th>
        <th>Fecha y Hora</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody>
      {% for estudiante in estudiantes_grupales %}
      <tr>
        <td>{{ estudiante.nombre }}</td>
        <td>{{ estudiante.correo }}</td>
        <td>{{ estudiante.edad }}</td>
        <td>{{ estudiante.sexo }}</td>
        <td>{{ estudiante.visita.institucion }}</td>
        <td>{{ estudiante.visita.nivel }}</td>
        <td>{{ estudiante.visita.fecha_confirmada }}</td>
        <td>
          <a href="{{ url_for('eliminar_estudiante_grupal', id=estudiante.id) }}"
             class="btn btn-sm btn-outline-danger eliminar-estudiante-btn"
             title="Eliminar estudiante">
             üóëÔ∏è
          </a>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<h2 class="section-title mt-5">Agregar Nuevo Horario</h2>

<form method="POST" action="{{ url_for('agregar_horario') }}" class="card p-4 shadow-sm border-0" style="background-color: #fdf9f3;">
  <div class="mb-3">
    <label for="fecha_hora" class="form-label fw-bold">Fecha y Hora</label>
    <input type="text" class="form-control" id="fecha_hora" name="fecha_hora"
           placeholder="Selecciona fecha y hora" required>
  </div>
  <div class="mb-3">
    <label for="disponibles" class="form-label fw-bold">N√∫mero de espacios disponibles</label>
    <input type="number" class="form-control" id="disponibles" name="disponibles"
           min="1" max="20" required>
  </div>
  <div class="text-center">
    <button type="submit" class="btn btn-pastel-primary w-100">
      Agregar Horario
    </button>
  </div>
</form>

<h2 class="section-title mt-5">Historial de Citas</h2>

<form method="get" class="row g-2 align-items-center mb-3">
  <div class="col-auto">
    <label for="rango" class="form-label fw-bold mb-0">Filtrar por fecha:</label>
  </div>
  <div class="col-auto">
    <select name="rango" id="rango" class="form-select form-select-sm">
      <option value="7" {% if rango == '7' %}selected{% endif %}>√öltimos 7 d√≠as</option>
      <option value="30" {% if rango == '30' %}selected{% endif %}>√öltimos 30 d√≠as</option>
      <option value="mes" {% if rango == 'mes' %}selected{% endif %}>Este mes</option>
      <option value="todo" {% if rango == 'todo' %}selected{% endif %}>Todo el historial</option>
    </select>
  </div>

  <div class="col-auto">
    <label for="tipo" class="form-label fw-bold mb-0">Tipo de cita:</label>
  </div>
  <div class="col-auto">
    <select name="tipo" id="tipo" class="form-select form-select-sm">
      <option value="todas" {% if tipo == 'todas' %}selected{% endif %}>Todas</option>
      <option value="individual" {% if tipo == 'individual' %}selected{% endif %}>Individual</option>
      <option value="grupal" {% if tipo == 'grupal' %}selected{% endif %}>Grupal</option>
    </select>
  </div>

  <div class="col-auto">
    <button type="submit" class="btn btn-pastel-primary btn-sm">Aplicar</button>
  </div>

  <div class="col-auto">
    <a href="{{ url_for('descargar_historial', rango=rango, tipo=tipo_filtro) }}"
       class="btn btn-pastel-success btn-sm">
      üì• Descargar historial en Excel
    </a>
  </div>
</form>

<div class="table-responsive" style="background-color: #fdf9f3; padding: 1rem; border-radius: 0.3rem;">
  <table class="table table-bordered table-hover shadow-sm" style="background-color: #fdf9f3;">
    <thead class="table-light">
      <tr>
        <th>Nombre</th>
        <th>Edad</th>
        <th>Sexo</th>
        <th>Instituci√≥n</th>
        <th>Nivel Acad√©mico</th>
        <th>Correo</th>
        <th>Tel√©fono</th>
        <th>Fecha y Hora</th>
        <th>Tipo</th>
        <th>Estado</th>
        <th>Asistencia</th>
        <th>Eliminar</th>
      </tr>
    </thead>
    <tbody>
      {% for registro in historial_completo %}
      <tr>
        <td>{{ registro.nombre }}</td>
        <td>{{ registro.edad or '‚Äî' }}</td>
        <td>{{ registro.sexo or '‚Äî' }}</td>
        <td>{{ registro.institucion or '‚Äî' }}</td>
        <td>{{ registro.nivel or '‚Äî' }}</td>
        <td>{{ registro.correo or '‚Äî' }}</td>
        <td>{{ registro.telefono or '‚Äî' }}</td>
        <td>{{ registro.fecha_hora }}</td>
        <td><span class="badge bg-info text-dark">{{ registro.tipo }}</span></td>
        <td>
          {% if registro.estado == 'cancelada' %}
            <span class="badge bg-secondary">Cancelada</span>
          {% else %}
            <span class="badge bg-primary">Finalizada</span>
          {% endif %}
        </td>
        <td style="vertical-align: middle;">
          {% if registro.estado == 'cancelada' %}
            <span class="badge bg-secondary">‚Äî</span>
          {% elif registro.tipo == 'Individual' %}
            <div class="d-flex align-items-center">
              {% if registro.asistio == 's√≠' %}
                <span class="badge bg-success mb-0">Asisti√≥</span>
              {% elif registro.asistio == 'no' %}
                <span class="badge bg-danger mb-0">No asisti√≥</span>
              {% else %}
                <span class="badge bg-warning mb-0">Sin definir</span>
              {% endif %}
              <button class="btn btn-sm btn-outline-primary ms-2"
                      type="button"
                      data-bs-toggle="collapse"
                      data-bs-target="#editar-{{ registro.id }}"
                      aria-expanded="false"
                      aria-controls="editar-{{ registro.id }}">
                Editar
              </button>
            </div>
            <div class="collapse mt-1" id="editar-{{ registro.id }}">
              <a href="{{ url_for('marcar_asistencia', id_cita=registro.id, estado='s√≠') }}"
                 class="btn btn-pastel-success btn-sm">‚úî Asisti√≥</a>
              <a href="{{ url_for('marcar_asistencia', id_cita=registro.id, estado='no') }}"
                 class="btn btn-pastel-danger btn-sm">‚úñ No asisti√≥</a>
            </div>
          {% else %}
            <span class="badge bg-success">Asisti√≥</span>
          {% endif %}
        </td>
        <td>
          {% if registro.tipo == 'Individual' %}
            {% if registro.estado == 'cancelada' %}
              <a href="{{ url_for('eliminar_cita', id_cita=registro.id) }}"
                 class="btn btn-outline-danger btn-sm"
                 title="Eliminar cita cancelada">
                 üóëÔ∏è
              </a>
           {% else %}
              <button class="btn btn-sm btn-disabled"
                      title="Solo se puede eliminar si la cita est√° cancelada">
                üóëÔ∏è
              </button>
            {% endif %}
          {% else %}
            <a href="{{ url_for('eliminar_estudiante_grupal', id=registro.id) }}"
               class="btn btn-outline-danger btn-sm"
               title="Eliminar estudiante de visita grupal">
               üóëÔ∏è
            </a>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


    <div class="text-center mt-4 mb-4">
        <a href="{{ url_for('logout') }}" class="btn btn-pastel-danger">Cerrar sesi√≥n</a>
    </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // Flatpickr para agregar horario
  flatpickr("#fecha_hora", {
    enableTime: true,
    dateFormat: "d/m/Y h:i K",
    time_24hr: false,
    minDate: "today"
  });

  // Flatpickr para todos los inputs que asignan fecha a visitas aceptadas
  flatpickr("input[name='fecha_confirmada']", {
    enableTime: true,
    dateFormat: "d/m/Y h:i K",
    time_24hr: false,
    minDate: "today"
  });

  // Confirmaciones para cancelar o eliminar
  document.addEventListener("DOMContentLoaded", function () {
    const enlaces = document.querySelectorAll(
      'a.btn-danger, a.btn-outline-danger, a.cancelar-visita-btn, a.eliminar-visita-btn, a.eliminar-estudiante-btn'
    );

    enlaces.forEach(function (enlace) {
      enlace.addEventListener('click', function (e) {
        const texto = enlace.textContent.toLowerCase();
        let mensaje = "¬øEst√°s seguro de que deseas continuar?";
        if (texto.includes("cancelar") && texto.includes("visita")) {
          mensaje = "¬øDeseas cancelar esta visita grupal?";
        } else if (texto.includes("cancelar")) {
          mensaje = "¬øDeseas cancelar esta cita u horario?";
        } else if (texto.includes("üóë")) {
          mensaje = "¬øDeseas eliminar este registro permanentemente?";
        }
        if (!confirm(mensaje)) {
          e.preventDefault();
        }
      });
    });
  });
</script>
</body>
</html>
