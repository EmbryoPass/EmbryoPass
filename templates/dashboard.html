<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Museo de Embriolog√≠a</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet" />

  <style>
    body {
      background-color: #fdf9f3;
      font-family: 'Roboto', sans-serif;
      color: #333;
      min-height: 100vh;
    }
    .container {
      background-color: transparent !important;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }
    h1, h2, h3 { font-weight: 700; color: #222; }

    .btn-pastel-primary  { background-color: #a7dffb; border-color: #a7dffb; color: #004e6b; }
    .btn-pastel-primary:hover  { background-color: #8fd3f5; border-color: #8fd3f5; }
    .btn-pastel-success  { background-color: #b9e4c9; border-color: #b9e4c9; color: #2e6e4c; }
    .btn-pastel-success:hover  { background-color: #a0d8b6; border-color: #a0d8b6; }
    .btn-pastel-danger   { background-color: #f7c6c7; border-color: #f7c6c7; color: #842029; }
    .btn-pastel-danger:hover   { background-color: #f3b0b2; border-color: #f3b0b2; }
    .btn-pastel-secondary{ background-color: #eaeaea; border-color: #eaeaea; color: #555; }
    .btn-pastel-secondary:hover{ background-color: #dcdcdc; border-color: #dcdcdc; }
    .btn-disabled {
      background-color: #f0f0f0; border-color: #f0f0f0; color: #999;
      cursor: not-allowed; pointer-events: none; opacity: 0.7;
    }

    .main-logo { display: block; margin: 1.5rem auto; height: 80px; }

    .title-text { text-align: center; margin: 2rem 0; }
    .title-text h1 {
      font-family: 'Nunito', sans-serif; font-size: 2.25rem; font-weight: 700;
      letter-spacing: 0.05em; color: #4a3526;
      padding-bottom: 0.5rem; border-bottom: 2px solid rgba(0,0,0,0.1);
      display: inline-block;
    }
    .title-text small { display: block; margin-top: 0.5rem; font-variant: small-caps; letter-spacing: 0.02em; color: #555; }

    .section-title { font-size: 1.75rem; font-weight: 700; margin-bottom: 1rem; }
    @media (max-width: 576px) {
      .section-title { font-size: 1.25rem; margin-bottom: 0.75rem; }
    }

    .table thead { background-color: #e9ecef; }

    /* Horario row que act√∫a de toggle */
    .horario-toggle-row { cursor: pointer; }
    .horario-toggle-row:hover td { background-color: #f0ebe3 !important; }

    /* Sub-tabla de citas */
    .citas-collapse { background-color: #fdf9f3; }
    .citas-collapse td { padding: 0 !important; }
    .citas-inner-wrap {
      padding: 0.75rem 1.5rem;
      border-left: 3px solid #a7dffb;
      background-color: #f7f3ee;
    }
    .citas-inner-wrap .table { margin-bottom: 0; background-color: transparent; }
    .citas-inner-wrap .table thead tr { background-color: #e0f0fb; }

    /* Flecha indicadora */
    .toggle-arrow { transition: transform .2s; display: inline-block; }
    .collapsed .toggle-arrow { transform: rotate(-90deg); }
  </style>
</head>
<body>
<div class="container">

  <!-- Logo y t√≠tulo -->
  <img src="{{ url_for('static', filename='logo.png') }}" alt="Logo Museo" class="main-logo">
  <div class="title-text">
    <h1>"Museo de Embriolog√≠a</h1>
    <small>Dra. Dora Virginia Ch√°vez Corral"</small>
  </div>

  <h1 class="text-center mb-4">Panel de Administraci√≥n</h1>

  {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
      {% for category, message in messages %}
        <div class="alert alert-{{ category }} text-center">{{ message }}</div>
      {% endfor %}
    {% endif %}
  {% endwith %}

  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HORARIOS PROGRAMADOS (con citas desplegables dentro)
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <h2 class="section-title mt-4">Horarios Programados</h2>

  <div class="table-responsive">
    <table class="table table-striped table-hover shadow-sm align-middle">
      <thead class="table-light">
        <tr>
          <th></th>
          <th>Fecha y Hora</th>
          <th>Lugares disponibles</th>
          <th>Capacidad total</th>
          <th>Citas agendadas</th>
          <th>Eliminar horario</th>
        </tr>
      </thead>
      <tbody>
        {% for horario in horarios %}

          {# Fila principal del horario ‚Äì hace toggle al collapse #}
          {% set collapse_id = 'citas-horario-' ~ horario.id %}
          <tr class="horario-toggle-row"
              data-bs-toggle="collapse"
              data-bs-target="#{{ collapse_id }}"
              aria-expanded="false"
              aria-controls="{{ collapse_id }}">
            <td class="text-center">
              <span class="toggle-arrow">‚ñº</span>
            </td>
            <td><strong>{{ horario.fecha_hora }}</strong></td>
            <td>
              {% if horario.disponibles == 0 %}
                <span class="badge bg-danger">Lleno</span>
              {% else %}
                <span class="badge bg-success">{{ horario.disponibles }}</span>
              {% endif %}
            </td>
            <td>{{ horario.total }}</td>
            <td>
              <span class="badge" style="background-color:#a7dffb;color:#004e6b;">
                {{ horario.citas | length }}
              </span>
            </td>
            <td>
              {# Stopropagation via onclick para que el link no dispare el toggle #}
              <a href="{{ url_for('admin.eliminar_horario', id_horario=horario.id) }}"
                 class="btn btn-pastel-danger btn-sm"
                 onclick="event.stopPropagation();">
                Eliminar
              </a>
            </td>
          </tr>

          {# Fila colapsable con las citas de este horario #}
          <tr class="citas-collapse collapse" id="{{ collapse_id }}">
            <td colspan="6">
              <div class="citas-inner-wrap">
                {% if horario.citas %}
                  <p class="mb-2 fw-bold text-muted small">
                    Citas agendadas para {{ horario.fecha_hora }}
                  </p>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered">
                      <thead>
                        <tr>
                          <th>Nombre</th>
                          <th>Edad</th>
                          <th>Sexo</th>
                          <th>Ciudad</th>
                          <th>Estado</th>
                          <th>Instituci√≥n</th>
                          <th>Nivel Acad√©mico</th>
                          <th>Correo</th>
                          <th>Tel√©fono</th>
                          <th>Cancelar</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for cita in horario.citas %}
                        <tr>
                          <td>{{ cita.nombre }}</td>
                          <td>{{ cita.edad or '‚Äî' }}</td>
                          <td>{{ cita.sexo or '‚Äî' }}</td>
                          <td>{{ cita.ciudad or '‚Äî' }}</td>
                          <td>{{ cita.estado_republica or '‚Äî' }}</td>
                          <td>{{ cita.institucion or '‚Äî' }}</td>
                          <td>{{ cita.nivel_educativo or '‚Äî' }}</td>
                          <td>{{ cita.correo }}</td>
                          <td>{{ cita.telefono }}</td>
                          <td>
                            <a href="{{ url_for('admin.cancelar_cita', id_cita=cita.id) }}"
                               class="btn btn-pastel-danger btn-sm"
                               onclick="event.stopPropagation();">
                              Cancelar
                            </a>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted mb-0 small">
                    Sin citas agendadas para este horario.
                  </p>
                {% endif %}
              </div>
            </td>
          </tr>

        {% else %}
          <tr>
            <td colspan="6" class="text-center text-muted">No hay horarios programados.</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       SOLICITUDES DE VISITAS GRUPALES
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <h2 class="section-title mt-5">Solicitudes de Visitas Grupales</h2>

  <div class="table-responsive">
    <table class="table table-bordered table-hover shadow-sm">
      <thead class="table-light">
        <tr>
          <th>Instituci√≥n / Plantel</th>
          <th>Encargado</th>
          <th>Correo</th>
          <th>Tel√©fono</th>
          <th>Nivel Acad√©mico</th>
          <th>Alumnos estimados</th>
          <th>Alumnos registrados</th>
          <th>Fechas Propuestas</th>
          <th>Comentarios</th>
          <th>Estado</th>
          <th>Fecha confirmada</th>
          <th>Lista de alumnos</th>
          <th>Acciones</th>
          <th>Cancelar</th>
          <th>Eliminar</th>
        </tr>
      </thead>
      <tbody>
        {% for visita in visitas_grupales %}
        <tr>
          <td>{{ visita.institucion }}</td>
          <td>{{ visita.encargado }}</td>
          <td>{{ visita.correo }}</td>
          <td>{{ visita.telefono }}</td>
          <td>
            {{ visita.nivel }}
            {% if visita.nivel == 'Bachillerato' and visita.bachillerato %}
              <br><small class="text-muted">{{ visita.bachillerato }}</small>
            {% endif %}
          </td>
          <td class="text-center">{{ visita.numero_alumnos }}</td>
          <td class="text-center">
            {% set n_est = visita.estudiantes | length %}
            {% if n_est > 0 %}
              <span class="badge bg-success">{{ n_est }}</span>
            {% else %}
              <span class="badge bg-secondary">0</span>
            {% endif %}
          </td>
          <td>{{ visita.fechas_preferidas }}</td>
          <td>{{ visita.comentarios or '‚Äî' }}</td>
          <td>
            {% if visita.estado == 'pendiente' %}
              <span class="badge bg-warning text-dark">Pendiente</span>
            {% elif visita.estado == 'aceptada' %}
              <span class="badge bg-success">Aceptada</span>
            {% elif visita.estado == 'rechazada' %}
              <span class="badge bg-danger">Rechazada</span>
            {% elif visita.estado == 'cancelada' %}
              <span class="badge bg-secondary">Cancelada</span>
            {% endif %}
          </td>
          <td>{{ visita.fecha_confirmada or '‚Äî' }}</td>

          {# ‚îÄ‚îÄ Columna: subir Excel de alumnos ‚îÄ‚îÄ #}
          <td>
            {% if visita.fecha_confirmada and visita.estado == 'aceptada' %}
              <form action="{{ url_for('admin.subir_excel_visita', id=visita.id) }}"
                    method="POST" enctype="multipart/form-data"
                    class="d-flex flex-column gap-1">
                <input type="file" name="excel_estudiantes" accept=".xlsx,.xls"
                       class="form-control form-control-sm" required>
                <button type="submit" class="btn btn-sm btn-pastel-primary">
                  üì§ Subir lista
                </button>
              </form>
              {% if visita.estudiantes | length > 0 %}
                <small class="text-muted d-block mt-1">
                  √öltima subida: {{ visita.estudiantes[-1].hora_registro }}
                </small>
              {% endif %}
            {% elif visita.estado == 'aceptada' %}
              <small class="text-muted">Asigna fecha primero</small>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </td>

          {# ‚îÄ‚îÄ Acciones: aceptar/rechazar o asignar fecha ‚îÄ‚îÄ #}
          <td>
            {% if visita.estado == 'pendiente' %}
              <a href="{{ url_for('admin.aceptar_visita', id=visita.id) }}"
                 class="btn btn-sm btn-pastel-success mb-1">Aceptar</a>
              <a href="{{ url_for('admin.rechazar_visita', id=visita.id) }}"
                 class="btn btn-sm btn-pastel-danger mb-1">Rechazar</a>
            {% elif visita.estado == 'aceptada' %}
              <form action="{{ url_for('admin.asignar_fecha_visita', id=visita.id) }}"
                    method="POST" class="d-flex flex-column">
                <input type="text" name="fecha_confirmada"
                       placeholder="dd/mm/aaaa hh:mm"
                       class="form-control form-control-sm mb-1 fecha-confirmada" required>
                <button type="submit"
                        class="btn btn-sm btn-pastel-primary btn-asignar-fecha"
                        disabled>Asignar Fecha</button>
              </form>
            {% endif %}
          </td>

          <td>
            {% set puede_cancelar = visita.estado in ['pendiente', 'aceptada'] %}
            {% if puede_cancelar %}
              <a href="{{ url_for('admin.cancelar_visita_grupal', id=visita.id) }}"
                 class="btn btn-sm btn-pastel-danger cancelar-visita-btn">
                Cancelar
              </a>
            {% elif visita.estado == 'rechazada' %}
              <button class="btn btn-sm btn-disabled" disabled
                      title="No disponible para solicitudes rechazadas">Cancelar</button>
            {% else %}
              <span class="badge bg-secondary">Cancelada</span>
            {% endif %}
          </td>
          <td>
            {% if visita.estado in ['cancelada', 'rechazada'] %}
              <a href="{{ url_for('admin.eliminar_visita_grupal', id=visita.id) }}"
                 class="btn btn-sm btn-outline-danger eliminar-visita-btn"
                 title="Eliminar visita {{ visita.estado }}">üóëÔ∏è</a>
            {% else %}
              <button class="btn btn-sm btn-disabled"
                      title="Solo se puede eliminar si la visita est√° cancelada o rechazada">üóëÔ∏è</button>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       AGREGAR NUEVO HORARIO
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <h2 class="section-title mt-5">Agregar Nuevo Horario</h2>

  <form method="POST" action="{{ url_for('admin.agregar_horario') }}"
        class="card p-4 shadow-sm border-0" style="background-color:#fdf9f3;">
    <div class="mb-3">
      <label for="fecha_hora" class="form-label fw-bold">Fecha y Hora</label>
      <input type="text" class="form-control" id="fecha_hora" name="fecha_hora"
             placeholder="Selecciona fecha y hora" required>
    </div>
    <div class="mb-3">
      <label for="disponibles" class="form-label fw-bold">N√∫mero de espacios disponibles</label>
      <input type="number" class="form-control" id="disponibles" name="disponibles"
             min="1" max="10" required>
    </div>
    <div class="text-center">
      <button type="submit" class="btn btn-pastel-primary w-100">Agregar Horario</button>
    </div>
  </form>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HISTORIAL DE CITAS
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <h2 class="section-title mt-5">Historial de Citas</h2>

  <form method="get" class="row g-2 align-items-center mb-3">
    <div class="col-auto">
      <label for="rango" class="form-label fw-bold mb-0">Filtrar por fecha:</label>
    </div>
    <div class="col-auto">
      <select name="rango" id="rango" class="form-select form-select-sm">
        <option value="7"   {% if rango == '7'   %}selected{% endif %}>√öltimos 7 d√≠as</option>
        <option value="30"  {% if rango == '30'  %}selected{% endif %}>√öltimos 30 d√≠as</option>
        <option value="mes" {% if rango == 'mes' %}selected{% endif %}>Este mes</option>
        <option value="todo"{% if rango == 'todo'%}selected{% endif %}>Todo el historial</option>
      </select>
    </div>
    <div class="col-auto">
      <button type="submit" class="btn btn-pastel-primary btn-sm">Aplicar</button>
    </div>
    <div class="col-12 col-md-auto mt-2 mt-md-0 d-flex gap-2 flex-wrap">
      <a href="{{ url_for('admin.descargar_historial', rango=rango, tipo='todas') }}"
         class="btn btn-pastel-success btn-sm">
        üì• Descargar ambos
      </a>
      <a href="{{ url_for('admin.descargar_historial', rango=rango, tipo='individual') }}"
         class="btn btn-pastel-secondary btn-sm">
        üì• Solo individuales
      </a>
      <a href="{{ url_for('admin.descargar_historial', rango=rango, tipo='grupal') }}"
         class="btn btn-pastel-secondary btn-sm">
        üì• Solo grupales
      </a>
    </div>
  </form>

  <div class="table-responsive" style="background-color:#fdf9f3;padding:1rem;border-radius:0.3rem;">
    <table class="table table-bordered table-hover shadow-sm" style="background-color:#fdf9f3;">
      <thead class="table-light">
        <tr>
          <th>Nombre</th>
          <th>Edad</th>
          <th>Sexo</th>
          <th>Ciudad</th>
          <th>Estado</th>
          <th>Instituci√≥n</th>
          <th>Nivel Acad√©mico</th>
          <th>Correo</th>
          <th>Tel√©fono</th>
          <th>Fecha y Hora</th>
          <th>Tipo</th>
          <th>Estado</th>
        </tr>
      </thead>
      <tbody>
        {% for registro in historial_completo %}
        <tr>
          <td>{{ registro.nombre }}</td>
          <td>{{ registro.edad or '‚Äî' }}</td>
          <td>{{ registro.sexo or '‚Äî' }}</td>
          <td>{{ registro.ciudad or '‚Äî' }}</td>
          <td>{{ registro.estado_rep or '‚Äî' }}</td>
          <td>{{ registro.institucion or '‚Äî' }}</td>
          <td>{{ registro.nivel or '‚Äî' }}</td>
          <td>{{ registro.correo or '‚Äî' }}</td>
          <td>{{ registro.telefono or '‚Äî' }}</td>
          <td>{{ registro.fecha_hora }}</td>
          <td><span class="badge bg-info text-dark">{{ registro.tipo }}</span></td>
          <td>
            <span class="badge" style="background-color:#b9e4c9;color:#2e6e4c;">Finalizada</span>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       HISTORIAL DE VISITAS GRUPALES
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <h2 class="section-title mt-5">Historial de Visitas Grupales</h2>

  <div class="table-responsive" style="background-color:#fdf9f3;padding:1rem;border-radius:0.3rem;">
    <table class="table table-bordered table-hover shadow-sm align-middle"
           style="background-color:#fdf9f3;">
      <thead class="table-light">
        <tr>
          <th></th>
          <th>Instituci√≥n / Plantel</th>
          <th>Nivel</th>
          <th>Ciudad</th>
          <th>Estado</th>
          <th>Encargado</th>
          <th>Fecha de visita</th>
          <th>Alumnos estimados</th>
          <th>Alumnos registrados</th>
        </tr>
      </thead>
      <tbody>
        {% for visita in historial_grupales %}
          {% set coll_id = 'hg-' ~ visita.id %}
          {# Fila principal clickeable #}
          <tr class="horario-toggle-row"
              data-bs-toggle="collapse"
              data-bs-target="#{{ coll_id }}"
              aria-expanded="false">
            <td class="text-center"><span class="toggle-arrow">‚ñº</span></td>
            <td><strong>{{ visita.institucion }}</strong></td>
            <td>
              {{ visita.nivel }}
              {% if visita.nivel == 'Bachillerato' and visita.bachillerato %}
                <br><small class="text-muted">{{ visita.bachillerato }}</small>
              {% endif %}
            </td>
            <td>{{ visita.ciudad or '‚Äî' }}</td>
            <td>{{ visita.estado_republica or '‚Äî' }}</td>
            <td>{{ visita.encargado }}</td>
            <td>{{ visita.fecha_confirmada }}</td>
            <td class="text-center">{{ visita.numero_alumnos }}</td>
            <td class="text-center">
              {% set n = visita.estudiantes | length %}
              {% if n > 0 %}
                <span class="badge bg-success">{{ n }}</span>
              {% else %}
                <span class="badge bg-secondary">0</span>
              {% endif %}
            </td>
          </tr>

          {# Fila expandible con lista de alumnos #}
          <tr class="citas-collapse collapse" id="{{ coll_id }}">
            <td colspan="9">
              <div class="citas-inner-wrap">
                {% if visita.estudiantes %}
                  <p class="mb-2 fw-bold text-muted small">
                    Lista de alumnos ‚Äì {{ visita.institucion }} ({{ visita.fecha_confirmada }})
                  </p>
                  <div class="table-responsive">
                    <table class="table table-sm table-bordered mb-0">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>Nombre</th>
                          <th>Edad</th>
                          <th>Sexo</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for est in visita.estudiantes %}
                        <tr>
                          <td>{{ loop.index }}</td>
                          <td>{{ est.nombre }}</td>
                          <td>{{ est.edad or '‚Äî' }}</td>
                          <td>{{ est.sexo or '‚Äî' }}</td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                  {# Bot√≥n para re-subir si necesitan actualizar la lista #}
                  <div class="mt-2">
                    <form action="{{ url_for('admin.subir_excel_visita', id=visita.id) }}"
                          method="POST" enctype="multipart/form-data"
                          class="d-flex align-items-center gap-2">
                      <input type="file" name="excel_estudiantes" accept=".xlsx,.xls"
                             class="form-control form-control-sm" style="max-width:260px;" required>
                      <button type="submit" class="btn btn-sm btn-pastel-primary text-nowrap">
                        üîÑ Actualizar lista
                      </button>
                    </form>
                    <small class="text-muted">
                      √öltima subida: {{ visita.estudiantes[-1].hora_registro }}
                    </small>
                  </div>
                {% else %}
                  <p class="text-muted mb-2 small">
                    No se ha subido la lista de alumnos para esta visita.
                  </p>
                  <form action="{{ url_for('admin.subir_excel_visita', id=visita.id) }}"
                        method="POST" enctype="multipart/form-data"
                        class="d-flex align-items-center gap-2">
                    <input type="file" name="excel_estudiantes" accept=".xlsx,.xls"
                           class="form-control form-control-sm" style="max-width:260px;" required>
                    <button type="submit" class="btn btn-sm btn-pastel-primary text-nowrap">
                      üì§ Subir lista
                    </button>
                  </form>
                {% endif %}
              </div>
            </td>
          </tr>

        {% else %}
          <tr>
            <td colspan="9" class="text-center text-muted">
              No hay visitas grupales en el per√≠odo seleccionado.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>


  <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
       CONTRASE√ëA DEL PANEL
       ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
  <div class="card mt-5">
    <div class="card-body">
      <h5 class="card-title">Contrase√±a del sitio web</h5>
      {% if admin_password %}
        <div class="mb-2">
          <label class="form-label">Contrase√±a actual</label>
          <div class="input-group">
            <input type="password" class="form-control" id="pwField" value="{{ admin_password }}" readonly>
            <button class="btn btn-outline-secondary" type="button" id="togglePw">Mostrar</button>
            <button class="btn btn-outline-secondary" type="button" id="copyPw">Copiar</button>
          </div>
          {% if admin_password_at %}
            <small class="text-muted">Generada el {{ admin_password_at }}</small>
          {% endif %}
        </div>
      {% else %}
        <p class="text-muted mb-2">A√∫n no has generado una contrase√±a.</p>
      {% endif %}
      <form method="POST" action="{{ url_for('admin.generar_password') }}">
        <button type="submit" class="btn btn-pastel-primary">Generar nueva contrase√±a</button>
      </form>
    </div>
  </div>

  <div class="text-center mt-4 mb-4">
    <a href="{{ url_for('admin.logout') }}" class="btn btn-pastel-danger">Cerrar sesi√≥n</a>
  </div>

</div>{# /container #}

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  // ‚îÄ‚îÄ Flatpickr: nuevo horario ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  flatpickr("#fecha_hora", {
    enableTime: true, dateFormat: "d/m/Y h:i K",
    time_24hr: false, minDate: "today"
  });

  // ‚îÄ‚îÄ Flatpickr: asignar fecha a visitas aceptadas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  flatpickr("input[name='fecha_confirmada']", {
    enableTime: true, dateFormat: "d/m/Y h:i K",
    time_24hr: false, minDate: "today"
  });

  // ‚îÄ‚îÄ Habilitar bot√≥n "Asignar Fecha" solo cuando el input tiene valor ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('form.d-flex.flex-column').forEach(function (form) {
      const inputFecha = form.querySelector('.fecha-confirmada');
      const btnAsignar = form.querySelector('.btn-asignar-fecha');
      if (inputFecha && btnAsignar) {
        inputFecha.addEventListener('input', function () {
          btnAsignar.disabled = inputFecha.value.trim() === '';
        });
      }
    });
  });

  // ‚îÄ‚îÄ Rotar flecha al abrir / cerrar collapse ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll('[data-bs-toggle="collapse"]').forEach(function (trigger) {
      const arrow = trigger.querySelector('.toggle-arrow');
      if (!arrow) return;

      const targetId = trigger.getAttribute('data-bs-target');
      const collapseEl = document.querySelector(targetId);
      if (!collapseEl) return;

      collapseEl.addEventListener('show.bs.collapse', function () {
        arrow.style.transform = 'rotate(0deg)';
      });
      collapseEl.addEventListener('hide.bs.collapse', function () {
        arrow.style.transform = 'rotate(-90deg)';
      });
      // Estado inicial: cerrado ‚Üí flecha apuntando a la derecha
      arrow.style.transform = 'rotate(-90deg)';
    });
  });

  // ‚îÄ‚îÄ Confirmaciones para acciones destructivas ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  document.addEventListener("DOMContentLoaded", function () {
    const enlaces = document.querySelectorAll(
      "a.btn-pastel-danger, a.btn-danger, a.btn-outline-danger, a.cancelar-visita-btn, a.eliminar-visita-btn"
    );
    enlaces.forEach(function (enlace) {
      enlace.addEventListener("click", function (e) {
        const texto = (enlace.textContent || "").toLowerCase().trim();
        let mensaje = "¬øEst√°s seguro de que deseas continuar?";
        if (texto.includes("cancelar") && texto.includes("visita")) {
          mensaje = "¬øDeseas cancelar esta visita grupal?";
        } else if (texto.includes("eliminar") || texto.includes("üóë")) {
          mensaje = "¬øDeseas eliminar este registro permanentemente?";
        } else if (texto.includes("cancelar")) {
          mensaje = "¬øDeseas cancelar esta cita u horario?";
        }
        if (!confirm(mensaje)) {
          e.preventDefault();
          e.stopPropagation();
        }
      });
    });
  });

  // ‚îÄ‚îÄ Contrase√±a: mostrar / copiar ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function () {
    const pwField = document.getElementById('pwField');
    const toggle  = document.getElementById('togglePw');
    const copy    = document.getElementById('copyPw');
    if (toggle && pwField) {
      toggle.addEventListener('click', () => {
        const isHidden = pwField.type === 'password';
        pwField.type = isHidden ? 'text' : 'password';
        toggle.textContent = isHidden ? 'Ocultar' : 'Mostrar';
      });
    }
    if (copy && pwField) {
      copy.addEventListener('click', async () => {
        try {
          await navigator.clipboard.writeText(pwField.value);
          copy.textContent = '¬°Copiado!';
          setTimeout(() => (copy.textContent = 'Copiar'), 1200);
        } catch (e) {
          alert('No se pudo copiar al portapapeles.');
        }
      });
    }
  })();
</script>
</body>
</html>
